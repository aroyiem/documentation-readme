#!/usr/bin/env node

var fs = require('fs')
var mdast = require('mdast')
var plugin = require('../lib/plugin')

var yargs = require('yargs')

yargs = yargs
  .usage('Usage: $0 documentation [file=README.md] --section "API" [--compare-only] [-- documentationjs options]')

  .alias('s', 'section')
  .describe('s', 'The section heading after which to inject generated documentation')
  .demand('s')

  .help('h')
  .alias('h', 'help')

  .version(function () {
    return require('../package').version;
  })

  .wrap(yargs.terminalWidth())

  .example('$0 -s "API Docs" -- index.js --github')

var dashdash = process.argv.indexOf('--')
if (dashdash < 0) {
  dashdash = process.argv.length
}
var arglist = process.argv.slice(2, dashdash)
var documentationArgs = process.argv.slice(dashdash)
var argv = yargs.parse(arglist)

if (documentationArgs.some(function (a) {
  return a === 'f' || a === 'format';
})) {
  console.log('Setting documentationjs format is not allowed in documentation-readme.')
  process.exit(1)
}

var readmeFile = argv._.length ? argv._[0] : 'README.md'
var readmeContent = fs.readFileSync(readmeFile, 'utf-8')

mdast.use(plugin, {
  section: argv.s,
  documentationArgs: documentationArgs
}).process(readmeContent, function (err, file, content) {
  if (err) {
    throw err
  }

  fs.writeFileSync(readmeFile, content)
})

